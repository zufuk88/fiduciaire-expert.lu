---
import LanguageSelector from './LanguageSelector.astro';
import Button from './ui/Button.astro';
import { useTranslation, type Language } from '../i18n/translations';
import { Image } from 'astro:assets';
import logoImage from '../assets/images/Logo.webp';
export interface Props {
  lang: Language;
}
const { lang } = Astro.props;
const t = useTranslation(lang);
// Navigation items avec sous-menus
const navItems = [
  { href: `/${lang}`, text: t('nav.home'), title: t('meta.title') },
  {
    href: `/${lang}/services`,
    text: t('nav.services'),
    title: t('nav.services'),
    subItems: [
      { href: `/${lang}/${lang === 'en' ? 'accounting' : 'comptabilite'}`, text: t('nav.accounting') },
      { href: `/${lang}/${lang === 'en' ? 'tax' : 'fiscalite'}`, text: t('nav.tax') },
      { href: `/${lang}/taxpertize`, text: lang === 'fr' ? 'Conseil fiscal (Taxpertize by Fiduciaire Expert)' : 'Tax Advisory (Taxpertize by Fiduciaire Expert)', isSubItem: true },
      { href: `/${lang}/${lang === 'en' ? 'company-formation-luxembourg' : 'creation-societe-luxembourg'}`, text: t('nav.company-creation') },
      { href: `/${lang}/${lang === 'en' ? 'payroll' : 'paie'}`, text: t('nav.payroll') }
    ]
  },
  { href: `/${lang}/articles`, text: t('nav.articles'), title: t('nav.articles') },
  { href: `/${lang}/${lang === 'en' ? 'about' : 'a-propos'}`, text: t('nav.about'), title: t('nav.about') },
];
// Schema de navigation pour SEO
const navigationSchema = {
  "@context": "https://schema.org",
  "@type": "SiteNavigationElement",
  "name": "Navigation principale Fiduciaire Expert",
  "hasPart": navItems.map((item, index) => ({
    "@type": "SiteNavigationElement",
    "name": item.text,
    "url": new URL(item.href, Astro.site).href,
    "position": index + 1
  }))
};
const currentPath = Astro.url.pathname;
const isActive = (path: string) => {
  if (path === `/${lang}`) {
    return currentPath === `/${lang}` || currentPath === `/${lang}/`;
  }
  return currentPath === path || currentPath.startsWith(path + '/');
};
---
<header class="site-header" itemscope itemtype="https://schema.org/WPHeader" role="banner">
  <div class="container header-container">
    <a href={`/${lang}`} class="logo-link" aria-label={t('common.back-to-home')} title={t('meta.title')}>
      <Image
        src={logoImage}
        alt="Logo Fiduciaire Expert - Cabinet Comptable Agréé Luxembourg"
        width={180}
        height={50}
        loading="eager"
        fetchpriority="high"
        itemprop="logo"
        quality="mid"
      />
    </a>
    <nav id="main-nav" class="main-navigation" role="navigation" aria-label="Navigation principale" itemscope itemtype="https://schema.org/SiteNavigationElement">
      <ul class="nav-list">
        {navItems.map((item) => (
          <li class="nav-item">
            <a
              href={item.href}
              class:list={{ 'is-active': isActive(item.href), 'has-submenu': !!item.subItems }}
              title={item.title}
              aria-current={isActive(item.href) ? 'page' : undefined}
              aria-haspopup={item.subItems ? 'true' : undefined}
              itemprop="url"
            >
              <span itemprop="name">{item.text}</span>
              {item.subItems && (
                <svg class="submenu-indicator" width="12" height="12" viewBox="0 0 12 12" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path d="M3 4.5L6 7.5L9 4.5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
              )}
            </a>
            {item.subItems && (
              <ul class="submenu" aria-label={`Sous-menu pour ${item.text}`}>
                {item.subItems.map(subItem => (
                  <li>
                    <a href={subItem.href} title={subItem.text} class:list={{'sub-item': subItem.isSubItem}}>
                      {subItem.text}
                    </a>
                  </li>
                ))}
              </ul>
            )}
          </li>
        ))}
        <li class="nav-item mobile-only">
          <a
            href={`/${lang}/contact`}
            class:list={{ 'is-active': isActive(`/${lang}/contact`) }}
            title={t('nav.contact')}
            aria-current={isActive(`/${lang}/contact`) ? 'page' : undefined}
            itemprop="url"
          >
            <span itemprop="name">{t('nav.contact')}</span>
          </a>
        </li>
      </ul>
    </nav>
    <div class="header-actions">
       <LanguageSelector />
       <Button href={`/${lang}/contact`} variant="primary" class="cta-desktop" title={t('nav.contact')}>{t('nav.contact')}</Button>
       <button id="burger-menu" type="button" aria-label="Ouvrir le menu de navigation" aria-expanded="false" aria-controls="main-nav">
         <span class="burger-line"></span>
         <span class="burger-line"></span>
         <span class="burger-line"></span>
       </button>
    </div>
  </div>
  <script type="application/ld+json" set:html={JSON.stringify(navigationSchema)} is:inline />
</header>
<style>
  .site-header { 
    position: sticky; 
    top: 0; 
    width: 100%; 
    z-index: 1000; 
    background-color: rgba(255, 255, 255, 0.95); /* Augmenté l'opacité */
    border-bottom: 1px solid rgba(0, 0, 0, 0.08);
     /* Optimisation GPU */
    transform: translateZ(0); /* Force l'accélération matérielle */
    -webkit-transform: translateZ(0);
  }
  /* Backdrop-filter uniquement pour Safari */
  @supports (backdrop-filter: blur(20px)) or (-webkit-backdrop-filter: blur(20px)) {
    .site-header {
      background-color: rgba(255, 255, 255, 0.8);
    }
  }
  /* Désactiver backdrop-filter sur Chrome pour la performance */
  @media screen and (-webkit-min-device-pixel-ratio:0) and (min-resolution:.001dpcm) {
    .site-header {
      background-color: rgba(255, 255, 255, 0.98);
    }
  }
  .container {
    max-width: 1200px;
    margin: 0 auto;
  }
  .header-container { 
    display: flex; 
    justify-content: space-between; 
    align-items: center; 
    height: 72px;
    padding: 0 2rem;
  }
  .logo-link {
    display: flex;
    align-items: center;
  }
  .logo-link:hover {
    opacity: 0.8;
  }
  .logo-link img { 
    height: 40px; 
    width: auto; 
    display: block; 
  }
  .header-actions { 
    display: flex; 
    align-items: center; 
    gap: 2rem; 
  }
  .cta-desktop { 
    display: none;
    padding: 0.5rem 1.25rem !important;
    font-size: 0.9375rem;
  }
  #burger-menu { 
    display: flex; 
    flex-direction: column; 
    justify-content: space-around; 
    width: 24px; 
    height: 18px; 
    background: transparent; 
    border: none; 
    cursor: pointer; 
    padding: 0; 
    z-index: 110;
  }
  .burger-line { 
    width: 100%; 
    height: 2px; 
    background-color: #525252; 
    transition: all 0.2s ease;
  }
  #burger-menu.is-open .burger-line:nth-child(1) { 
    transform: translateY(8px) rotate(45deg); 
  }
  #burger-menu.is-open .burger-line:nth-child(2) { 
    opacity: 0; 
  }
  #burger-menu.is-open .burger-line:nth-child(3) { 
    transform: translateY(-8px) rotate(-45deg); 
  }
  @media (min-width: 992px) {
    #burger-menu { display: none; }
    .cta-desktop { 
      display: inline-block;
      padding: 0.5rem 1.25rem !important;
      font-size: 0.9375rem;
    }
    .main-navigation { display: flex; }
    .nav-list { 
      display: flex; 
      align-items: center; 
      list-style: none; 
      gap: 2.5rem; 
    }
    .nav-item { position: relative; }
    .nav-item.mobile-only { display: none; }
    .nav-item > a { 
      color: #64748b; 
      font-weight: 450; 
      text-decoration: none; 
      padding: 0.5rem 0; 
      position: relative;
      font-size: 0.9375rem;
      letter-spacing: -0.01em;
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
    }
    .nav-item > a:hover {
      color: #1e3a5f;
    }
    .nav-item > a.is-active { 
      color: #1e3a5f;
      font-weight: 600;
    }
    .submenu-indicator {
      opacity: 0.5;
      transition: transform 0.3s ease, opacity 0.2s ease;
    }
    .nav-item:hover .submenu-indicator {
      opacity: 1;
      transform: rotate(180deg);
    }
    .submenu { 
      position: absolute; 
      top: calc(100% + 0.5rem); 
      left: 50%; 
      transform: translateX(-50%);
      padding: 8px;
      min-width: 260px; 
      background: #ffffff;
      border: 1px solid #e5e7eb;
      border-radius: 2px;
      list-style: none; 
      opacity: 0; 
      visibility: hidden;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
      transition: all 0.2s ease;
    }
    .submenu::before {
      content: '';
      position: absolute;
      top: -5px;
      left: 50%;
      transform: translateX(-50%) rotate(45deg);
      width: 10px;
      height: 10px;
      background: #ffffff;
      border-top: 1px solid #e5e7eb;
      border-left: 1px solid #e5e7eb;
    }
    .submenu::after {
      content: '';
      position: absolute;
      top: -0.5rem;
      left: 0;
      right: 0;
      height: 0.5rem;
      background: transparent;
    }
    .nav-item:hover .submenu { 
      opacity: 1; 
      visibility: visible;
    }
    .submenu li {
      margin: 0;
    }
    .submenu li:hover {
      background: #fafbfc;
    }
    .submenu a { 
      display: block;
      padding: 12px 16px; 
      color: #525252; 
      white-space: nowrap;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.2s ease;
      text-decoration: none;
      border-left: 2px solid transparent;
    }
    .submenu a:hover { 
      color: #1e3a5f;
      background: #fafbfc;
      text-decoration: none;
      border-left-color: #1e3a5f;
    }
    /* Style pour Taxpertize - sous-élément de Fiscalité */
    .submenu a.sub-item {
      padding-left: 32px;
      font-size: 13px;
      color: #6b7280;
      background: transparent;
      border-left: 2px solid #e5e7eb;
      margin-left: 12px;
      font-weight: 400;
    }
    .submenu a.sub-item:hover {
      color: #525252;
      background: #f5f5f5;
      border-left-color: #9ca3af;
    }
  }
  @media (max-width: 991px) {
    /* Afficher le sélecteur de langue sur mobile */
    .header-actions .language-selector {
      display: block;
    }
    .main-navigation { 
      position: fixed; 
      top: 0; 
      left: 0; 
      width: 100%; 
      height: 100vh; 
      background-color: #ffffff; 
      transform: translateX(-100%); 
      padding-top: 72px; 
      overflow-y: auto;
      transition: transform 0.3s ease;
      box-shadow: 2px 0 12px rgba(0, 0, 0, 0.08);
    }
    .main-navigation.is-open { 
      transform: translateX(0); 
    }
    .nav-list { 
      list-style: none; 
      display: flex; 
      flex-direction: column; 
    }
    .nav-item > a { 
      display: block; 
      padding: 18px 24px; 
      font-size: 15px; 
      font-weight: 500; 
      color: #525252;
      position: relative;
      -webkit-tap-highlight-color: transparent;
      text-decoration: none;
      border-bottom: 1px solid #f0f0f0;
      transition: all 0.2s ease;
    }
    .nav-item > a:hover {
      color: #1e3a5f;
      background: #fafbfc;
      text-decoration: none;
      padding-left: 28px;
    }
    .nav-item > a.is-active { 
      color: #1e3a5f;
      font-weight: 600;
      background-color: #fafbfc;
      text-decoration: none;
      border-left: 3px solid #1e3a5f;
    }
    .submenu { 
      list-style: none; 
      background: transparent;
      margin: 0;
      padding: 0;
    }
    .submenu a { 
      display: block; 
      padding: 14px 24px 14px 48px; 
      font-size: 14px; 
      color: #6b7280;
      -webkit-tap-highlight-color: transparent;
      text-decoration: none;
      border-bottom: 1px solid #f0f0f0;
      transition: all 0.2s ease;
      position: relative;
    }
    .submenu a::before {
      content: "—";
      position: absolute;
      left: 28px;
      color: #d1d5db;
    }
    .submenu a:hover {
      background-color: #fafbfc;
      color: #1e3a5f;
      text-decoration: none;
    }
    /* Style pour Taxpertize mobile - sous-élément de Fiscalité */
    .submenu a.sub-item {
      padding-left: 64px;
      font-size: 13px;
      color: #9ca3af;
      font-weight: 400;
    }
    .submenu a.sub-item::before {
      content: "·";
      left: 48px;
    }
    .submenu a.sub-item:hover {
      color: #525252;
    }
  }
</style>
<script>
  // Script pour le menu mobile et mega menu
  document.addEventListener('DOMContentLoaded', () => {
    const burgerMenu = document.getElementById('burger-menu');
    const mainNav = document.getElementById('main-nav');
    if (burgerMenu && mainNav) {
      // Gestion du clic sur le burger menu
      burgerMenu.addEventListener('click', () => {
        const isOpen = burgerMenu.classList.contains('is-open');
        // Toggle les classes
        burgerMenu.classList.toggle('is-open');
        mainNav.classList.toggle('is-open');
        // Met à jour l'attribut ARIA
        burgerMenu.setAttribute('aria-expanded', (!isOpen).toString());
        // Empêche le scroll du body quand le menu est ouvert
        document.body.style.overflow = !isOpen ? 'hidden' : '';
      });
      // Ferme le menu quand on clique sur un lien
      const navLinks = mainNav.querySelectorAll('a');
      navLinks.forEach(link => {
        link.addEventListener('click', () => {
          burgerMenu.classList.remove('is-open');
          mainNav.classList.remove('is-open');
          burgerMenu.setAttribute('aria-expanded', 'false');
          document.body.style.overflow = '';
        });
      });
      // Ferme le menu quand on redimensionne la fenêtre au-dessus du breakpoint
      let resizeTimer: ReturnType<typeof setTimeout>;
      window.addEventListener('resize', () => {
        clearTimeout(resizeTimer);
        resizeTimer = setTimeout(() => {
          if (window.innerWidth >= 992) {
            burgerMenu.classList.remove('is-open');
            mainNav.classList.remove('is-open');
            burgerMenu.setAttribute('aria-expanded', 'false');
            document.body.style.overflow = '';
          }
        }, 250);
      });
      // Ferme le menu avec la touche Escape
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && burgerMenu.classList.contains('is-open')) {
          burgerMenu.classList.remove('is-open');
          mainNav.classList.remove('is-open');
          burgerMenu.setAttribute('aria-expanded', 'false');
          document.body.style.overflow = '';
        }
      });
    }
  });
</script>