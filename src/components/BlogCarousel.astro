---
import { getCollection } from 'astro:content';
import { Image } from 'astro:assets';
import SectionTitle from './SectionTitle.astro';
import Button from './ui/Button.astro';
import { calculateReadingTime } from '../utils/reading-time';

export interface Props {
  title: string;
  subtitle?: string;
  maxPosts?: number;
  lang?: 'fr' | 'en';
  category?: string;
  variant?: 'carousel' | 'grid' | 'grid-featured';
  showAll?: boolean;
  showTitle?: boolean;
  showCTA?: boolean;
  columns?: 2 | 3 | 4;
  skipFirst?: number;
  posts?: any[];
  featuredFirst?: boolean; // Show first post as featured
}

const {
  title,
  subtitle,
  maxPosts = 4,
  lang = 'fr',
  category,
  variant = 'carousel',
  showAll = false,
  showTitle = true,
  showCTA = true,
  columns = 3,
  skipFirst = 0,
  posts: providedPosts,
  featuredFirst = false
} = Astro.props;

const ctaHref = lang === 'fr' ? '/fr/articles' : '/en/articles';
const ctaText = lang === 'fr' ? 'Voir tous les articles' : 'View all articles';

// Use provided posts if available, otherwise fetch them
let sortedPosts;
if (providedPosts) {
  sortedPosts = providedPosts;
} else {
  // Récupérer les articles publiés et triés par date
  const allPosts = await getCollection('blog', ({ data, slug }) => {
    const isCorrectLang = slug.startsWith(`${lang}/`);
    const isCategoryMatch = category ? data.category === category : true;
    return data.draft !== true && isCorrectLang && isCategoryMatch;
  });

  sortedPosts = allPosts
    .sort((a, b) => {
      const dateA = new Date(a.data.modified || a.data.date).getTime();
      const dateB = new Date(b.data.modified || b.data.date).getTime();
      return dateB - dateA;
    });
}

const displayedPosts = showAll 
  ? sortedPosts.slice(skipFirst) 
  : sortedPosts.slice(skipFirst, skipFirst + maxPosts);

// Fonction pour formater la date
const formatDate = (date: Date) => {
  return new Intl.DateTimeFormat(lang === 'fr' ? 'fr-FR' : 'en-GB', {
    year: 'numeric',
    month: 'long',
    day: 'numeric'
  }).format(date);
};

// Fonction pour extraire un extrait du contenu
const getExcerpt = (content: string, maxLength: number = 120) => {
  const plainText = content
    .replace(/^---[\s\S]*?---/m, '')
    .replace(/<[^>]*>/g, '')
    .replace(/\[([^\]]+)\]\([^)]+\)/g, '$1')
    .replace(/[#*_`~]/g, '')
    .trim();
  return plainText.length > maxLength 
    ? plainText.substring(0, maxLength) + '...' 
    : plainText;
};
---

<section class="blog-section">
  {showTitle && (
    <SectionTitle 
      title={title}
      subtitle={subtitle}
    />
  )}
  
  <div class="container">
    <div class={variant === 'carousel' ? 'carousel' : featuredFirst ? 'grid grid-featured' : `grid grid-${columns}`}>
      <div class={variant === 'carousel' ? 'carousel-track' : 'articles'} id="blog-carousel">
        {displayedPosts.map((post, index) => (
          <article class={`article-card ${featuredFirst && index === 0 ? 'featured-card' : ''}`}>
            {post.data.image && (
              <a href={`/${lang}/articles/${post.slug.replace(`${lang}/`, '')}`} class="image-link">
                <Image 
                  src={post.data.image} 
                  alt={post.data.title}
                  width={320}
                  height={180}
                  loading="lazy"
                  quality="mid"
                  class="article-image"
                />
              </a>
            )}
            
            <div class="article-content">
              <div class="meta">
                <a href={`/${lang}/articles/category/${post.data.category.toLowerCase().replace(/\s+/g, '-')}`} class="category">
                  {post.data.category}
                </a>
                <span class="date">
                  {formatDate(post.data.modified && new Date(post.data.modified) > new Date(post.data.date) 
                    ? new Date(post.data.modified) 
                    : post.data.date)}
                </span>
                <span class="reading-time">
                  {calculateReadingTime(post.body, lang)} min
                </span>
              </div>
              
              <h3>
                <a href={`/${lang}/articles/${post.slug.replace(`${lang}/`, '')}`}>
                  {post.data.title}
                </a>
              </h3>
              
              <p class="excerpt">
                {post.data.description || getExcerpt(post.body)}
              </p>
              
              <a href={`/${lang}/articles/${post.slug.replace(`${lang}/`, '')}`} class="read-more">
                {lang === 'fr' ? 'Lire →' : 'Read →'}
              </a>
            </div>
          </article>
        ))}
      </div>
      
      {variant === 'carousel' && (
        <>
          <button class="nav prev" aria-label="Previous">‹</button>
          <button class="nav next" aria-label="Next">›</button>
          <div class="carousel-indicators">
            {displayedPosts.map((_, index) => (
              <span class="indicator" data-index={index} aria-label={`Aller \u00e0 l'article ${index + 1}`}></span>
            ))}
          </div>
        </>
      )}
    </div>
    
    {showCTA && (
      <div class="footer">
        <Button href={ctaHref} variant="primary">
          {ctaText}
        </Button>
      </div>
    )}
  </div>
</section>

<style>
  .blog-section {
    padding: 120px 20px 140px;
  }
  
  /* When used inside article pages, remove padding */
  .posts-column .blog-section {
    padding: 0;
    background: transparent;
  }

  .container {
    max-width: 1200px;
    margin: 0 auto;
  }
  
  /* Full width in article pages */
  .posts-column .container {
    max-width: 100%;
  }

  /* Carousel */
  .carousel {
    position: relative;
  }

  .carousel-track {
    display: flex;
    gap: 32px;
    overflow-x: auto;
    scrollbar-width: none;
    -ms-overflow-style: none;
    padding-bottom: 4px;
    scroll-behavior: smooth;
    scroll-snap-type: x mandatory;
    -webkit-overflow-scrolling: touch;
  }

  .carousel-track::-webkit-scrollbar {
    display: none;
  }

  /* Indicateurs de position */
  .carousel-indicators {
    display: flex;
    gap: 8px;
    justify-content: center;
    margin-top: 24px;
  }

  .indicator {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: var(--input-border);
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .indicator.active {
    background: var(--primary);
    width: 24px;
    border-radius: 4px;
  }

  .indicator:hover {
    background: var(--muted);
  }

  /* Grid */
  .grid {
    display: grid;
    gap: 24px;
  }

  .articles {
    display: grid;
    gap: 24px;
  }
  
  .grid-2 > .articles {
    grid-template-columns: repeat(2, 1fr);
  }
  
  .grid-3 > .articles {
    grid-template-columns: repeat(3, 1fr);
  }
  
  .grid-4 > .articles {
    grid-template-columns: repeat(4, 1fr);
  }
  
  /* Grid avec featured */
  .grid-featured > .articles {
    grid-template-columns: repeat(2, 1fr);
    grid-auto-rows: auto;
  }
  
  /* Featured card prend toute la largeur et est plus grande */
  .featured-card {
    grid-column: 1 / -1;  /* Prend toute la largeur */
    grid-row: 1;
    display: grid;
    grid-template-columns: 50% 50%;
    min-height: 320px;
    background: var(--card-hover);
    align-items: stretch;
  }
  
  .featured-card .image-link {
    height: 320px;
    aspect-ratio: unset;
    overflow: hidden;
  }
  
  .featured-card .image-link img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    object-position: center;
  }
  
  .featured-card .article-content {
    padding: 32px 36px;
    display: flex;
    flex-direction: column;
    justify-content: center;
    min-height: 320px;
  }
  
  .featured-card h3 {
    font-size: 1.5rem;
    font-weight: 700;
  }
  
  .featured-card .excerpt {
    -webkit-line-clamp: 3;
    font-size: 0.95rem;
  }
  
  @media (max-width: 968px) {
    .featured-card {
      grid-template-columns: 1fr;
      min-height: auto;
    }
    
    .featured-card .image-link {
      height: 220px;
      aspect-ratio: unset;
    }
    
    .featured-card .article-content {
      min-height: auto;
      padding: 24px;
    }
    
    .featured-card .article-content {
      padding: 24px;
    }
  }
  
  @media (max-width: 768px) {
    .grid-featured > .articles {
      grid-template-columns: 1fr;
    }
  }

  /* Article Card */
  .article-card {
    background: var(--card);
    border: 1px solid var(--card-border);
    border-radius: 2px;
    overflow: hidden;
    display: flex;
    flex-direction: column;
    transition: all 0.2s ease;
  }
  
  /* Carousel specific width */
  .carousel-track .article-card {
    flex: 0 0 320px;
    min-width: 320px;
    scroll-snap-align: start;
  }

  .article-card:hover {
    background: var(--card-hover);
    border-color: var(--primary);
    box-shadow: 0 4px 12px rgba(30, 58, 95, 0.08);
  }

  /* Accessibilit\u00e9 clavier */
  .article-card:focus-within {
    outline: 2px solid var(--primary);
    outline-offset: 2px;
  }

  .image-link {
    display: block;
    aspect-ratio: 16/9;
    min-height: 180px;
    background: linear-gradient(135deg, var(--muted-bg) 0%, var(--card-border) 100%);
    overflow: hidden;
    position: relative;
  }
  
  .image-link::after {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(to bottom, transparent 0%, rgba(30, 58, 95, 0.03) 100%);
  }

  .article-image {
    width: 100%;
    height: 100%;
    object-fit: cover;
    opacity: 0.95;
  }
  
  .article-card:hover .article-image {
    opacity: 1;
  }

  .article-content {
    display: flex;
    flex-direction: column;
    flex-grow: 1;
    padding: 24px;
  }

  /* Meta */
  .meta {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 12px;
    font-size: 12px;
    color: var(--muted);
  }

  .category {
    color: var(--primary);
    text-decoration: none;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 1px;
    font-size: 11px;
  }

  .category:hover {
    color: var(--fg);
  }

  .date::before {
    content: '—';
    margin-right: 8px;
    color: var(--border);
  }

  .reading-time::before {
    content: '—';
    margin-right: 8px;
    color: var(--border);
  }

  /* Title */
  h3 {
    font-size: var(--font-h3);
    font-weight: 600;
    margin: 0 0 14px 0;
    line-height: 1.4;
  }

  h3 a {
    color: var(--primary);
    text-decoration: none;
    display: block;
  }

  h3 a:hover {
    color: var(--fg);
  }

  /* Excerpt */
  .excerpt {
    font-size: var(--font-body) !important;
    line-height: 1.7;
    color: var(--fg);
    margin: 0 0 20px 0;
    flex-grow: 1;
  }

  /* Read More */
  .read-more {
    font-size: var(--font-h6);
    font-weight: 600;
    color: var(--primary);
    text-decoration: none;
    margin-top: auto;
    display: inline-flex;
    align-items: center;
    gap: 6px;
    transition: gap 0.2s ease;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .read-more:hover {
    color: var(--fg);
    gap: 10px;
  }

  /* Navigation */
  .nav {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    width: 40px;
    height: 40px;
    background: var(--card-hover);
    border: 1px solid var(--border);
    border-radius: 2px;
    font-size: var(--font-h4);
    color: var(--muted);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 2;
    transition: all 0.2s ease;
  }

  .nav:hover {
    background: var(--bg);
    border-color: var(--muted);
    color: var(--fg);
  }

  .nav:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }

  .prev {
    left: -24px;
  }

  .next {
    right: -24px;
  }

  /* Footer */
  .footer {
    text-align: center;
    margin-top: 48px;
  }

  /* Les styles du bouton sont gérés par le composant Button */

  /* Responsive */
  @media (max-width: 1024px) {
    .grid-3 .articles,
    .grid-4 .articles {
      grid-template-columns: repeat(2, 1fr);
    }
  }

  @media (max-width: 768px) {
    .blog-section {
      padding: 80px 16px 100px;
    }
    
    /* No padding when inside article pages */
    .posts-column .blog-section {
      padding: 0;
    }

    .carousel-track {
      gap: 16px;
    }

    .carousel-track .article-card {
      flex: 0 0 280px;
      min-width: 280px;
      max-width: 280px;
    }

    .grid-2 .articles,
    .grid-3 .articles,
    .grid-4 .articles {
      grid-template-columns: 1fr;
      gap: 16px;
    }
    
    .articles {
      gap: 16px;
    }

    .nav {
      display: none;
    }
  }

  @media (max-width: 480px) {
    .blog-section {
      padding: 60px 12px 80px;
    }
    
    .posts-column .blog-section {
      padding: 0;
    }
    
    .carousel-track .article-card {
      flex: 0 0 260px;
      min-width: 260px;
      max-width: 260px;
    }
  }


    .article-card {
      background: var(--card);
      border-color: var(--card-border);
    }

    .article-card:hover {
      background: var(--card-hover);
      border-color: var(--border);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }

    .indicator {
      background: var(--muted);
    }

    .indicator.active {
      background: var(--accent);
    }

    .indicator:hover {
      background: var(--fg-secondary);
    }

    .image-link {
      background: linear-gradient(135deg, var(--card) 0%, var(--card-border) 100%);
    }

    .image-link::after {
      background: linear-gradient(to bottom, transparent 0%, rgba(0, 0, 0, 0.2) 100%);
    }

    .meta {
      color: var(--muted);
    }

    .category {
      color: var(--accent);
    }

    .category:hover {
      color: var(--accent-hover);
    }

    .date::before,
    .reading-time::before {
      color: var(--border);
    }

    h3 a {
      color: var(--fg);
    }

    h3 a:hover {
      color: var(--muted);
    }

    .excerpt {
      color: var(--muted);
    }

    .read-more {
      color: var(--accent);
    }

    .read-more:hover {
      color: var(--accent-hover);
    }

    .nav {
      background: var(--card);
      border-color: var(--card-border);
      color: var(--muted);
    }

    .nav:hover {
      background: var(--card-hover);
      border-color: var(--border);
      color: var(--fg);
    }

    /* Styles du bouton gérés par le composant Button */
  }























</style>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const track = document.getElementById('blog-carousel');
    const prevBtn = document.querySelector('.nav.prev') as HTMLButtonElement;
    const nextBtn = document.querySelector('.nav.next') as HTMLButtonElement;
    const indicators = document.querySelectorAll('.indicator');
    
    if (!track || !prevBtn || !nextBtn) return;
    
    const cards = track.querySelectorAll('.article-card');
    const cardWidth = (cards?.[0] as HTMLElement)?.offsetWidth + 32 || 400;
    
    // Navigation boutons
    prevBtn.addEventListener('click', () => {
      track.scrollBy({ left: -cardWidth, behavior: 'smooth' });
    });
    
    nextBtn.addEventListener('click', () => {
      track.scrollBy({ left: cardWidth, behavior: 'smooth' });
    });
    
    // Indicateurs cliquables
    indicators.forEach((indicator, index) => {
      indicator.addEventListener('click', () => {
        track.scrollTo({ left: index * cardWidth, behavior: 'smooth' });
      });
    });
    
    // Update indicateurs et boutons
    const updateUI = () => {
      const scrollPosition = track.scrollLeft;
      const currentIndex = Math.round(scrollPosition / cardWidth);
      
      // Update indicateurs
      indicators.forEach((indicator, index) => {
        if (index === currentIndex) {
          indicator.classList.add('active');
        } else {
          indicator.classList.remove('active');
        }
      });
      
      // Update boutons
      const isAtStart = track.scrollLeft <= 0;
      const isAtEnd = track.scrollLeft >= track.scrollWidth - track.clientWidth - 10;
      prevBtn.disabled = isAtStart;
      nextBtn.disabled = isAtEnd;
    };
    
    track.addEventListener('scroll', updateUI);
    updateUI();
  });
</script>