---
import { getCollection } from 'astro:content';
import { Image } from 'astro:assets';
import SectionTitle from './SectionTitle.astro';
import { calculateReadingTime } from '../utils/reading-time';

export interface Props {
  title: string;
  subtitle?: string;
  maxPosts?: number;
  lang?: 'fr' | 'en';
  category?: string;
  variant?: 'carousel' | 'grid' | 'grid-featured';
  showAll?: boolean;
  showTitle?: boolean;
  showCTA?: boolean;
  columns?: 2 | 3 | 4;
  skipFirst?: number;
  posts?: any[];
  featuredFirst?: boolean; // Show first post as featured
}

const {
  title,
  subtitle,
  maxPosts = 4,
  lang = 'fr',
  category,
  variant = 'carousel',
  showAll = false,
  showTitle = true,
  showCTA = true,
  columns = 3,
  skipFirst = 0,
  posts: providedPosts,
  featuredFirst = false
} = Astro.props;

const ctaHref = lang === 'fr' ? '/fr/articles' : '/en/articles';
const ctaText = lang === 'fr' ? 'Voir tous les articles' : 'View all articles';

// Use provided posts if available, otherwise fetch them
let sortedPosts;
if (providedPosts) {
  sortedPosts = providedPosts;
} else {
  // Récupérer les articles publiés et triés par date
  const allPosts = await getCollection('blog', ({ data, slug }) => {
    const isCorrectLang = slug.startsWith(`${lang}/`);
    const isCategoryMatch = category ? data.category === category : true;
    return data.draft !== true && isCorrectLang && isCategoryMatch;
  });

  sortedPosts = allPosts
    .sort((a, b) => {
      const dateA = new Date(a.data.modified || a.data.date).getTime();
      const dateB = new Date(b.data.modified || b.data.date).getTime();
      return dateB - dateA;
    });
}

const displayedPosts = showAll 
  ? sortedPosts.slice(skipFirst) 
  : sortedPosts.slice(skipFirst, skipFirst + maxPosts);

// Fonction pour formater la date
const formatDate = (date: Date) => {
  return new Intl.DateTimeFormat(lang === 'fr' ? 'fr-FR' : 'en-GB', {
    year: 'numeric',
    month: 'long',
    day: 'numeric'
  }).format(date);
};

// Fonction pour extraire un extrait du contenu
const getExcerpt = (content: string, maxLength: number = 120) => {
  const plainText = content
    .replace(/^---[\s\S]*?---/m, '')
    .replace(/<[^>]*>/g, '')
    .replace(/\[([^\]]+)\]\([^)]+\)/g, '$1')
    .replace(/[#*_`~]/g, '')
    .trim();
  return plainText.length > maxLength 
    ? plainText.substring(0, maxLength) + '...' 
    : plainText;
};
---

<section class="blog-section">
  {showTitle && (
    <SectionTitle 
      title={title}
      subtitle={subtitle}
    />
  )}
  
  <div class="container">
    <div class={variant === 'carousel' ? 'carousel' : featuredFirst ? 'grid grid-featured' : `grid grid-${columns}`}>
      <div class={variant === 'carousel' ? 'carousel-track' : 'articles'} id="blog-carousel">
        {displayedPosts.map((post, index) => (
          <article class={`article-card ${featuredFirst && index === 0 ? 'featured-card' : ''}`}>
            {post.data.image && (
              <a href={`/${lang}/articles/${post.slug.replace(`${lang}/`, '')}`} class="image-link">
                <Image 
                  src={post.data.image} 
                  alt={post.data.title}
                  width={320}
                  height={180}
                  loading="lazy"
                  quality="mid"
                  class="article-image"
                />
              </a>
            )}
            
            <div class="article-content">
              <div class="meta">
                <a href={`/${lang}/articles/category/${post.data.category.toLowerCase().replace(/\s+/g, '-')}`} class="category">
                  {post.data.category}
                </a>
                <span class="date">
                  {formatDate(post.data.modified && new Date(post.data.modified) > new Date(post.data.date) 
                    ? new Date(post.data.modified) 
                    : post.data.date)}
                </span>
                <span class="reading-time">
                  {calculateReadingTime(post.body, lang)} min
                </span>
              </div>
              
              <h3>
                <a href={`/${lang}/articles/${post.slug.replace(`${lang}/`, '')}`}>
                  {post.data.title}
                </a>
              </h3>
              
              <p class="excerpt">
                {post.data.description || getExcerpt(post.body)}
              </p>
              
              <a href={`/${lang}/articles/${post.slug.replace(`${lang}/`, '')}`} class="read-more">
                {lang === 'fr' ? 'Lire →' : 'Read →'}
              </a>
            </div>
          </article>
        ))}
      </div>
      
      {variant === 'carousel' && (
        <>
          <button class="nav prev" aria-label="Previous">‹</button>
          <button class="nav next" aria-label="Next">›</button>
          <div class="carousel-indicators">
            {displayedPosts.map((_, index) => (
              <span class="indicator" data-index={index} aria-label={`Aller \u00e0 l'article ${index + 1}`}></span>
            ))}
          </div>
        </>
      )}
    </div>
    
    {showCTA && (
      <div class="footer">
        <a href={ctaHref} class="cta">
          <span>{ctaText}</span>
        </a>
      </div>
    )}
  </div>
</section>

<style>
  .blog-section {
    padding: 120px 20px 140px;
  }
  
  /* When used inside article pages, remove padding */
  .posts-column .blog-section {
    padding: 0;
    background: transparent;
  }

  .container {
    max-width: 1200px;
    margin: 0 auto;
  }
  
  /* Full width in article pages */
  .posts-column .container {
    max-width: 100%;
  }

  /* Carousel */
  .carousel {
    position: relative;
  }

  .carousel-track {
    display: flex;
    gap: 32px;
    overflow-x: auto;
    scrollbar-width: none;
    -ms-overflow-style: none;
    padding-bottom: 4px;
    scroll-behavior: smooth;
    scroll-snap-type: x mandatory;
    -webkit-overflow-scrolling: touch;
  }

  .carousel-track::-webkit-scrollbar {
    display: none;
  }

  /* Indicateurs de position */
  .carousel-indicators {
    display: flex;
    gap: 8px;
    justify-content: center;
    margin-top: 24px;
  }

  .indicator {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: #d1d5db;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .indicator.active {
    background: #1e3a5f;
    width: 24px;
    border-radius: 4px;
  }

  .indicator:hover {
    background: #9ca3af;
  }

  /* Grid */
  .grid {
    display: grid;
    gap: 24px;
  }

  .articles {
    display: grid;
    gap: 24px;
  }
  
  .grid-2 > .articles {
    grid-template-columns: repeat(2, 1fr);
  }
  
  .grid-3 > .articles {
    grid-template-columns: repeat(3, 1fr);
  }
  
  .grid-4 > .articles {
    grid-template-columns: repeat(4, 1fr);
  }
  
  /* Grid avec featured */
  .grid-featured > .articles {
    grid-template-columns: repeat(2, 1fr);
    grid-auto-rows: auto;
  }
  
  /* Featured card prend toute la largeur et est plus grande */
  .featured-card {
    grid-column: 1 / -1;  /* Prend toute la largeur */
    grid-row: 1;
    display: grid;
    grid-template-columns: 50% 50%;
    min-height: 320px;
    background: #ffffff;
    align-items: stretch;
  }
  
  .featured-card .image-link {
    height: 320px;
    aspect-ratio: unset;
    overflow: hidden;
  }
  
  .featured-card .image-link img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    object-position: center;
  }
  
  .featured-card .article-content {
    padding: 32px 36px;
    display: flex;
    flex-direction: column;
    justify-content: center;
    min-height: 320px;
  }
  
  .featured-card h3 {
    font-size: 1.5rem;
    font-weight: 700;
  }
  
  .featured-card .excerpt {
    -webkit-line-clamp: 3;
    font-size: 0.95rem;
  }
  
  @media (max-width: 968px) {
    .featured-card {
      grid-template-columns: 1fr;
      min-height: auto;
    }
    
    .featured-card .image-link {
      height: 220px;
      aspect-ratio: unset;
    }
    
    .featured-card .article-content {
      min-height: auto;
      padding: 24px;
    }
    
    .featured-card .article-content {
      padding: 24px;
    }
  }
  
  @media (max-width: 768px) {
    .grid-featured > .articles {
      grid-template-columns: 1fr;
    }
  }

  /* Article Card */
  .article-card {
    background: #fafbfc;
    border: 1px solid #e5e7eb;
    border-radius: 2px;
    overflow: hidden;
    display: flex;
    flex-direction: column;
    transition: all 0.2s ease;
  }
  
  /* Carousel specific width */
  .carousel-track .article-card {
    flex: 0 0 320px;
    min-width: 320px;
    scroll-snap-align: start;
  }

  .article-card:hover {
    background: #ffffff;
    border-color: #1e3a5f;
    box-shadow: 0 4px 12px rgba(30, 58, 95, 0.08);
  }

  /* Accessibilit\u00e9 clavier */
  .article-card:focus-within {
    outline: 2px solid #1e3a5f;
    outline-offset: 2px;
  }

  .image-link {
    display: block;
    aspect-ratio: 16/9;
    min-height: 180px;
    background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%);
    overflow: hidden;
    position: relative;
  }
  
  .image-link::after {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(to bottom, transparent 0%, rgba(30, 58, 95, 0.03) 100%);
  }

  .article-image {
    width: 100%;
    height: 100%;
    object-fit: cover;
    opacity: 0.95;
  }
  
  .article-card:hover .article-image {
    opacity: 1;
  }

  .article-content {
    display: flex;
    flex-direction: column;
    flex-grow: 1;
    padding: 24px;
  }

  /* Meta */
  .meta {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 12px;
    font-size: 12px;
    color: #6b7280;
  }

  .category {
    color: #1e3a5f;
    text-decoration: none;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 1px;
    font-size: 11px;
  }

  .category:hover {
    color: #374151;
  }

  .date::before {
    content: '—';
    margin-right: 8px;
    color: #d1d5db;
  }

  .reading-time::before {
    content: '—';
    margin-right: 8px;
    color: #d1d5db;
  }

  /* Title */
  h3 {
    font-size: var(--font-h3);
    font-weight: 600;
    margin: 0 0 14px 0;
    line-height: 1.4;
  }

  h3 a {
    color: #1e3a5f;
    text-decoration: none;
    display: block;
  }

  h3 a:hover {
    color: #4b5563;
  }

  /* Excerpt */
  .excerpt {
    font-size: var(--font-body) !important;
    line-height: 1.7;
    color: #525252;
    margin: 0 0 20px 0;
    flex-grow: 1;
  }

  /* Read More */
  .read-more {
    font-size: var(--font-h6);
    font-weight: 600;
    color: #1e3a5f;
    text-decoration: none;
    margin-top: auto;
    display: inline-flex;
    align-items: center;
    gap: 6px;
    transition: gap 0.2s ease;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .read-more:hover {
    color: #374151;
    gap: 10px;
  }

  /* Navigation */
  .nav {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    width: 40px;
    height: 40px;
    background: #ffffff;
    border: 1px solid #d1d5db;
    border-radius: 2px;
    font-size: var(--font-h4);
    color: #6b7280;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 2;
    transition: all 0.2s ease;
  }

  .nav:hover {
    background: #f9fafb;
    border-color: #9ca3af;
    color: #374151;
  }

  .nav:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }

  .prev {
    left: -24px;
  }

  .next {
    right: -24px;
  }

  /* Footer */
  .footer {
    text-align: center;
    margin-top: 48px;
  }

  .cta {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 12px 28px;
    background: transparent;
    color: #1e3a5f;
    border: 2px solid #1e3a5f;
    border-radius: 2px;
    text-decoration: none;
    font-size: var(--font-h5);
    font-weight: 600;
    transition: all 0.2s ease;
    position: relative;
    overflow: hidden;
    letter-spacing: 0.025em;
  }

  .cta:hover {
    background: #1e3a5f;
    color: #ffffff;
  }

  .cta::after {
    content: '→';
    display: inline-block;
    transition: transform 0.2s ease;
    font-size: 18px;
  }

  .cta:hover::after {
    transform: translateX(4px);
  }

  /* Responsive */
  @media (max-width: 1024px) {
    .grid-3 .articles,
    .grid-4 .articles {
      grid-template-columns: repeat(2, 1fr);
    }
  }

  @media (max-width: 768px) {
    .blog-section {
      padding: 80px 16px 100px;
    }
    
    /* No padding when inside article pages */
    .posts-column .blog-section {
      padding: 0;
    }

    .carousel-track {
      gap: 16px;
    }

    .carousel-track .article-card {
      flex: 0 0 calc(100vw - 32px);
      min-width: calc(100vw - 32px);
    }

    .grid-2 .articles,
    .grid-3 .articles,
    .grid-4 .articles {
      grid-template-columns: 1fr;
      gap: 16px;
    }
    
    .articles {
      gap: 16px;
    }

    .nav {
      display: none;
    }
  }

  @media (max-width: 480px) {
    .blog-section {
      padding: 60px 12px 80px;
    }
    
    .posts-column .blog-section {
      padding: 0;
    }
    
    .carousel-track .article-card {
      flex: 0 0 calc(100vw - 24px);
      min-width: calc(100vw - 24px);
    }
  }

  /* Support du mode sombre */
  @media (prefers-color-scheme: dark) {
    .blog-section {
      background: #0f172a;
    }

    .article-card {
      background: #1e293b;
      border-color: #334155;
    }

    .article-card:hover {
      background: #263449;
      border-color: #475569;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }

    .indicator {
      background: #475569;
    }

    .indicator.active {
      background: #60a5fa;
    }

    .indicator:hover {
      background: #64748b;
    }

    .image-link {
      background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
    }

    .image-link::after {
      background: linear-gradient(to bottom, transparent 0%, rgba(0, 0, 0, 0.2) 100%);
    }

    .meta {
      color: #94a3b8;
    }

    .category {
      color: #60a5fa;
    }

    .category:hover {
      color: #93c5fd;
    }

    .date::before,
    .reading-time::before {
      color: #475569;
    }

    h3 a {
      color: #f1f5f9;
    }

    h3 a:hover {
      color: #e2e8f0;
    }

    .excerpt {
      color: #94a3b8;
    }

    .read-more {
      color: #60a5fa;
    }

    .read-more:hover {
      color: #93c5fd;
    }

    .nav {
      background: #1e293b;
      border-color: #334155;
      color: #94a3b8;
    }

    .nav:hover {
      background: #263449;
      border-color: #475569;
      color: #f1f5f9;
    }

    .cta {
      color: #60a5fa;
      border-color: #60a5fa;
    }

    .cta:hover {
      background: #60a5fa;
      color: #0f172a;
    }
  }

  /* Support du mode sombre avec classe sur body */
  :global(body.dark) .blog-section {
    background: #0f172a;
  }

  :global(body.dark) .article-card {
    background: #1e293b;
    border-color: #334155;
  }

  :global(body.dark) .article-card:hover {
    background: #263449;
    border-color: #475569;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
  }

  :global(body.dark) .indicator {
    background: #475569;
  }

  :global(body.dark) .indicator.active {
    background: #60a5fa;
  }

  :global(body.dark) .indicator:hover {
    background: #64748b;
  }

  :global(body.dark) .image-link {
    background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
  }

  :global(body.dark) .image-link::after {
    background: linear-gradient(to bottom, transparent 0%, rgba(0, 0, 0, 0.2) 100%);
  }

  :global(body.dark) .meta {
    color: #94a3b8;
  }

  :global(body.dark) .category {
    color: #60a5fa;
  }

  :global(body.dark) .category:hover {
    color: #93c5fd;
  }

  :global(body.dark) .date::before,
  :global(body.dark) .reading-time::before {
    color: #475569;
  }

  :global(body.dark) h3 a {
    color: #f1f5f9;
  }

  :global(body.dark) h3 a:hover {
    color: #e2e8f0;
  }

  :global(body.dark) .excerpt {
    color: #94a3b8;
  }

  :global(body.dark) .read-more {
    color: #60a5fa;
  }

  :global(body.dark) .read-more:hover {
    color: #93c5fd;
  }

  :global(body.dark) .nav {
    background: #1e293b;
    border-color: #334155;
    color: #94a3b8;
  }

  :global(body.dark) .nav:hover {
    background: #263449;
    border-color: #475569;
    color: #f1f5f9;
  }

  :global(body.dark) .cta {
    color: #60a5fa;
    border-color: #60a5fa;
  }

  :global(body.dark) .cta:hover {
    background: #60a5fa;
    color: #0f172a;
  }
</style>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const track = document.getElementById('blog-carousel');
    const prevBtn = document.querySelector('.nav.prev') as HTMLButtonElement;
    const nextBtn = document.querySelector('.nav.next') as HTMLButtonElement;
    const indicators = document.querySelectorAll('.indicator');
    
    if (!track || !prevBtn || !nextBtn) return;
    
    const cards = track.querySelectorAll('.article-card');
    const cardWidth = (cards?.[0] as HTMLElement)?.offsetWidth + 32 || 400;
    
    // Navigation boutons
    prevBtn.addEventListener('click', () => {
      track.scrollBy({ left: -cardWidth, behavior: 'smooth' });
    });
    
    nextBtn.addEventListener('click', () => {
      track.scrollBy({ left: cardWidth, behavior: 'smooth' });
    });
    
    // Indicateurs cliquables
    indicators.forEach((indicator, index) => {
      indicator.addEventListener('click', () => {
        track.scrollTo({ left: index * cardWidth, behavior: 'smooth' });
      });
    });
    
    // Update indicateurs et boutons
    const updateUI = () => {
      const scrollPosition = track.scrollLeft;
      const currentIndex = Math.round(scrollPosition / cardWidth);
      
      // Update indicateurs
      indicators.forEach((indicator, index) => {
        if (index === currentIndex) {
          indicator.classList.add('active');
        } else {
          indicator.classList.remove('active');
        }
      });
      
      // Update boutons
      const isAtStart = track.scrollLeft <= 0;
      const isAtEnd = track.scrollLeft >= track.scrollWidth - track.clientWidth - 10;
      prevBtn.disabled = isAtStart;
      nextBtn.disabled = isAtEnd;
    };
    
    track.addEventListener('scroll', updateUI);
    updateUI();
  });
</script>