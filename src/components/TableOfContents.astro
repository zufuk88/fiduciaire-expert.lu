---
export interface Props {
  headings: Array<{
    depth: number;
    text: string;
    slug: string;
  }>;
  lang?: 'fr' | 'en';
}

const { headings, lang = 'fr' } = Astro.props;

// Filtrer seulement les h2 et h3 pour la table des matières
const tocHeadings = headings.filter(heading => heading.depth === 2 || heading.depth === 3);

const title = lang === 'fr' ? 'Table des matières' : 'Table of Contents';
---

{tocHeadings.length > 2 && (
  <nav class="table-of-contents" aria-label={title}>
    <h3 class="toc-title">{title}</h3>
    <ul class="toc-list">
      {tocHeadings.map((heading) => (
        <li class={`toc-item toc-level-${heading.depth}`}>
          <a href={`#${heading.slug}`} class="toc-link" data-toc-link>
            {heading.text}
          </a>
        </li>
      ))}
    </ul>
  </nav>
)}

<style>
  .table-of-contents {
    background: #f8fafc;
    border: 1px solid #e2e8f0;
    border-radius: 4px;
    padding: 1.5rem;
    margin-bottom: 0;
    max-height: calc(100vh - 220px); /* Viewport height - header - sticky bar - spacing */
    display: flex;
    flex-direction: column;
  }

  .toc-title {
    font-size: 1rem;
    font-weight: 600;
    color: #0f172a;
    margin-bottom: 1.25rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    flex-shrink: 0;
  }

  .toc-list {
    list-style: none;
    margin: 0;
    padding: 0;
    overflow-y: auto;
    overflow-x: hidden;
    padding-right: 0.5rem; /* Space for scrollbar */
  }

  .toc-item {
    margin: 0;
    padding: 0;
  }

  .toc-level-3 {
    margin-left: 1.75rem;
  }

  .toc-link {
    display: block;
    padding: 0.5rem 0;
    color: #64748b;
    text-decoration: none;
    font-size: 0.875rem;
    line-height: 1.4;
    transition: all 0.2s ease;
    border-left: 3px solid transparent;
    padding-left: 1rem;
    margin-left: -1rem;
    white-space: normal;
    word-wrap: break-word;
  }

  .toc-link:hover {
    color: #3b82f6;
    border-left-color: #dbeafe;
  }

  .toc-link.active {
    color: #3b82f6;
    font-weight: 600;
    border-left-color: #3b82f6;
    background: linear-gradient(90deg, rgba(59, 130, 246, 0.05) 0%, transparent 100%);
  }

  /* Scrollbar styles */
  .toc-list::-webkit-scrollbar {
    width: 6px;
  }

  .toc-list::-webkit-scrollbar-track {
    background: transparent;
    border-radius: 3px;
  }

  .toc-list::-webkit-scrollbar-thumb {
    background: #cbd5e1;
    border-radius: 3px;
    transition: background 0.2s ease;
  }

  .toc-list::-webkit-scrollbar-thumb:hover {
    background: #94a3b8;
  }
  
  /* Firefox scrollbar */
  .toc-list {
    scrollbar-width: thin;
    scrollbar-color: #cbd5e1 transparent;
  }
  
  /* Fade effect at bottom when scrollable */
  .table-of-contents::after {
    content: '';
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    height: 2rem;
    background: linear-gradient(to top, #f8fafc, transparent);
    pointer-events: none;
    opacity: 0;
    transition: opacity 0.3s ease;
  }
  
  .table-of-contents.has-scroll::after {
    opacity: 1;
  }

  /* Mobile styles */
  @media (max-width: 1200px) {
    .table-of-contents {
      position: static;
      margin-bottom: 2rem;
      max-height: none;
    }
  }

  @media (max-width: 768px) {
    .table-of-contents {
      padding: 1rem;
    }

    .toc-title {
      font-size: 0.875rem;
    }

    .toc-link {
      font-size: 0.875rem;
      padding: 0.375rem 0;
    }
  }
</style>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const tocLinks = document.querySelectorAll('[data-toc-link]');
    const headings = document.querySelectorAll('.article-content h2, .article-content h3');
    const tocElement = document.querySelector('.table-of-contents');
    const tocList = document.querySelector('.toc-list');
    
    if (tocLinks.length === 0 || headings.length === 0) return;
    
    // Check if scrollbar is needed and add fade effect
    if (tocList && tocElement) {
      const checkScroll = () => {
        if (tocList.scrollHeight > tocList.clientHeight) {
          tocElement.classList.add('has-scroll');
        } else {
          tocElement.classList.remove('has-scroll');
        }
      };
      
      checkScroll();
      window.addEventListener('resize', checkScroll);
    }

    // Intersection Observer pour mettre en évidence le heading actuel
    const observerOptions = {
      rootMargin: '-20% 0px -70% 0px',
      threshold: 0
    };

    let activeLink: Element | null = null;

    const observer = new IntersectionObserver((entries) => {
      entries.forEach(entry => {
        if (entry.isIntersecting) {
          // Retirer la classe active de tous les liens
          tocLinks.forEach(link => link.classList.remove('active'));
          
          // Trouver et activer le lien correspondant
          const targetId = entry.target.getAttribute('id');
          const correspondingLink = document.querySelector(`[href="#${targetId}"]`);
          
          if (correspondingLink) {
            correspondingLink.classList.add('active');
            activeLink = correspondingLink;
            
            // Auto-scroll ToC to show active item
            if (tocList) {
              const linkRect = correspondingLink.getBoundingClientRect();
              const listRect = tocList.getBoundingClientRect();
              const linkTop = linkRect.top - listRect.top + tocList.scrollTop;
              const linkBottom = linkTop + linkRect.height;
              
              if (linkTop < tocList.scrollTop) {
                tocList.scrollTo({
                  top: linkTop - 20,
                  behavior: 'smooth'
                });
              } else if (linkBottom > tocList.scrollTop + tocList.clientHeight) {
                tocList.scrollTo({
                  top: linkBottom - tocList.clientHeight + 20,
                  behavior: 'smooth'
                });
              }
            }
          }
        }
      });
    }, observerOptions);

    // Observer tous les headings
    headings.forEach(heading => {
      if (heading.id) {
        observer.observe(heading);
      }
    });

    // Smooth scroll pour les liens
    tocLinks.forEach(link => {
      link.addEventListener('click', (e) => {
        e.preventDefault();
        const targetId = link.getAttribute('href')?.substring(1);
        const targetElement = document.getElementById(targetId || '');
        
        if (targetElement) {
          const headerOffset = 100; // Hauteur du header sticky
          const elementPosition = targetElement.getBoundingClientRect().top;
          const offsetPosition = elementPosition + window.pageYOffset - headerOffset;

          window.scrollTo({
            top: offsetPosition,
            behavior: 'smooth'
          });
        }
      });
    });
  });
</script>