---
import LayoutI18n from './LayoutI18n.astro';
import { Image } from 'astro:assets';
import { getCollection } from 'astro:content';
import Button from '../components/ui/Button.astro';
import ArticleHero from '../components/hero/ArticleHero.astro';
import TableOfContents from '../components/TableOfContents.astro';
import StickyPageTop from '../components/StickyPageTop.astro';
import BlogCarousel from '../components/BlogCarousel.astro';
import { calculateReadingTime } from '../utils/reading-time';
import '../styles/blog-articles.css';
const { frontmatter } = Astro.props;
const { title, seoTitle, description, date, modified, category, image, imageAlt, author, rawContent, headings } = frontmatter;
// Calculate reading time
const readingTime = rawContent ? calculateReadingTime(rawContent, 'en') : 5;
const pageTitle = seoTitle || title;
const siteUrl = Astro.site ? Astro.site.origin : "https://www.fiduciaire-expert.lu";
const articleUrl = new URL(Astro.url.pathname, siteUrl).href;
// Get articles from the same category
const allPosts = await getCollection('blog');
const relatedPosts = allPosts
  .filter(post => 
    post.data.category === category && 
    post.data.title !== title && 
    post.data.draft !== true &&
    post.id.startsWith('en/')
  )
  .sort((a, b) => b.data.date.getTime() - a.data.date.getTime())
  .slice(0, 3);
// Get only English categories for English layout
const englishCategories = ['Tax', 'Payroll', 'Accounting', 'Corporate Law'];
const categories = englishCategories;
// Schema Article pour SEO
const articleSchema = {
  "@type": "Article",
  "@id": articleUrl,
  "headline": title,
  "description": description,
  "image": image ? (typeof image === 'string' ? image : new URL(image.src, siteUrl).href) : undefined,
  "datePublished": date,
  "dateModified": modified || date,
  "author": {
    "@type": "Organization",
    "name": "Fiduciaire Expert",
    "url": siteUrl
  },
  "publisher": {
    "@type": "Organization",
    "name": "Fiduciaire Expert",
    "url": siteUrl,
    "logo": {
      "@type": "ImageObject",
      "url": new URL("/images/Logo.webp", siteUrl).href
    }
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": articleUrl
  },
  "inLanguage": "en-US",
  "articleSection": category,
  "keywords": category
};
// Schema Breadcrumb
const breadcrumbSchema = {
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position": 1,
      "name": "Home",
      "item": new URL("/en", siteUrl).href
    },
    {
      "@type": "ListItem",
      "position": 2,
      "name": "Blog",
      "item": new URL("/en/articles", siteUrl).href
    },
    {
      "@type": "ListItem",
      "position": 3,
      "name": category,
      "item": new URL(`/en/articles/category/${category.toLowerCase().replace(/\s+/g, '-')}`, siteUrl).href
    },
    {
      "@type": "ListItem",
      "position": 4,
      "name": title
    }
  ]
};
// Schema combiné pour le contexte
const combinedSchema = {
  "@context": "https://schema.org",
  "@graph": [articleSchema, breadcrumbSchema]
};
---
<LayoutI18n
  title={pageTitle}
  description={description}
  canonical={articleUrl}
  schema={combinedSchema}
>
  <article class="article-page" itemscope itemtype="https://schema.org/Article">
    <ArticleHero 
      image={image}
    />
    <StickyPageTop
      breadcrumbItems={[
        { text: 'Home', href: '/en' },
        { text: 'Articles', href: '/en/articles' },
        { text: category, href: `/en/articles/category/${category.toLowerCase().replace(/\s+/g, '-')}` }
      ]}
      title={title}
      showSearch={true}
      searchPlaceholder="Search articles..."
      lang="en"
      showProgress={true}
    />
    
    <!-- Article Metadata -->
    <div class="article-meta-section">
      <div class="article-meta-container">
        <div class="meta-item">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
            <line x1="16" y1="2" x2="16" y2="6"/>
            <line x1="8" y1="2" x2="8" y2="6"/>
            <line x1="3" y1="10" x2="21" y2="10"/>
          </svg>
          <time datetime={modified || date}>
            {new Date(modified || date).toLocaleDateString('en-US', { 
              day: 'numeric', 
              month: 'long', 
              year: 'numeric' 
            })}
          </time>
        </div>
        
        <div class="meta-item">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
            <circle cx="12" cy="7" r="4"/>
          </svg>
          <span>{author || 'Fiduciaire Expert'}</span>
        </div>
        
        <div class="meta-item">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10"/>
            <polyline points="12 6 12 12 16 14"/>
          </svg>
          <span>{readingTime} min read</span>
        </div>
        
        <div class="meta-item meta-category">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/>
          </svg>
          <a href={`/en/articles/category/${category.toLowerCase().replace(/\s+/g, '-')}`}>
            {category}
          </a>
        </div>
      </div>
    </div>
    
    <div class="article-body-wrapper">
      <div class="article-layout">
        <div class="article-main">
          <div class="article-content" itemprop="articleBody">
            <slot />
            {/* Social share buttons - moved after content */}
            <div class="social-share">
              <span class="share-label">Share this article:</span>
            <a 
              href={`https://www.linkedin.com/sharing/share-offsite/?url=${encodeURIComponent(articleUrl)}`}
              target="_blank"
              rel="noopener noreferrer"
              class="share-button share-linkedin"
              aria-label="Share on LinkedIn"
            >
              <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                <path d="M19 0h-14c-2.761 0-5 2.239-5 5v14c0 2.761 2.239 5 5 5h14c2.762 0 5-2.239 5-5v-14c0-2.761-2.238-5-5-5zm-11 19h-3v-11h3v11zm-1.5-12.268c-.966 0-1.75-.79-1.75-1.764s.784-1.764 1.75-1.764 1.75.79 1.75 1.764-.783 1.764-1.75 1.764zm13.5 12.268h-3v-5.604c0-3.368-4-3.113-4 0v5.604h-3v-11h3v1.765c1.396-2.586 7-2.777 7 2.476v6.759z"/>
              </svg>
              LinkedIn
            </a>
            <a 
              href={`https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(articleUrl)}`}
              target="_blank"
              rel="noopener noreferrer"
              class="share-button share-facebook"
              aria-label="Share on Facebook"
            >
              <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                <path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/>
              </svg>
              Facebook
            </a>
            <a 
              href={`https://twitter.com/intent/tweet?url=${encodeURIComponent(articleUrl)}&text=${encodeURIComponent(title)}`}
              target="_blank"
              rel="noopener noreferrer"
              class="share-button share-x"
              aria-label="Share on X"
            >
              <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                <path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/>
              </svg>
              X
            </a>
            <button 
              onclick="navigator.clipboard.writeText(window.location.href).then(() => { this.textContent = 'Copied!'; setTimeout(() => { this.innerHTML = '<svg width=\'20\' height=\'20\' viewBox=\'0 0 24 24\' fill=\'none\' stroke=\'currentColor\' stroke-width=\'2\'><rect x=\'9\' y=\'9\' width=\'13\' height=\'13\' rx=\'2\' ry=\'2\'/><path d=\'M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1\'/></svg>Copy link'; }, 2000); })"
              class="share-button share-copy"
              aria-label="Copy link"
            >
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="9" y="9" width="13" height="13" rx="2" ry="2"/>
                <path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"/>
              </svg>
              Copy link
            </button>
          </div>
            {/* Simplified CTA */}
            <div class="article-cta-simple">
              <a href="/en/contact" class="cta-button-simple">
                Contact
              </a>
            </div>
          </div>
        </div>
        <!-- Sidebar -->
        <aside class="article-sidebar">
          <!-- Table of Contents -->
          {headings && headings.length > 2 && (
            <TableOfContents headings={headings} lang="en" />
          )}
        </aside>
      </div>
    </div>
    <BlogCarousel
      title="Similar articles"
      subtitle={`Continue reading with these articles from the ${category} category`}
      lang="en"
      variant="grid"
      columns={3}
      category={category}
      excludeSlug={Astro.url.pathname}
      maxPosts={3}
    />
  </article>
</LayoutI18n>
<style>
  /* ===== DESIGN PREMIUM ÉPURÉ ET STATUTAIRE ===== */
  /* Variables for sticky heights */
  :root {
    --header-height: 72px;
    --breadcrumb-height: 48px;
    --sticky-gap: 20px;
    --sidebar-top: calc(var(--header-height) + var(--breadcrumb-height) + var(--sticky-gap));
  }
  /* Layout avec sidebar */
  .article-layout {
    max-width: 1280px;
    margin: 0 auto;
    display: grid;
    grid-template-columns: 1fr 360px;
    gap: 3rem;
    padding: 0 2rem;
    align-items: start;
  }
  @media (max-width: 1200px) {
    .article-layout {
      grid-template-columns: 1fr;
      max-width: 720px;
    }
    .article-sidebar {
      display: none;
    }
  }
  .article-main {
    min-width: 0;
    max-width: 720px;
  }
  /* Image dans le contenu */
  .article-featured-image { 
    margin: 0 0 5rem 0;
    position: relative;
    overflow: hidden;
    line-height: 0;
    border-radius: 4px;
  }
  .article-featured-image::after {
    content: '';
    position: absolute;
    bottom: -3.5rem;
    left: 50%;
    transform: translateX(-50%);
    width: 80px;
    height: 1px;
    background: linear-gradient(to right, transparent, #e2e8f0 20%, #e2e8f0 80%, transparent);
  }
  .article-featured-image img,
  .article-featured-image :global(img) { 
    width: 100%;
    height: auto;
    max-height: 400px;
    object-fit: cover;
    display: block;
  }
  /* Wrapper avec espace de lecture optimal */
  .article-body-wrapper { 
    padding: 2rem 0 4rem 0; /* Reduced padding-top because we have the sticky breadcrumb */
    background-color: #ffffff; 
    position: relative;
  }
  /* Article Metadata Section */
  .article-meta-section {
    background: #f8fafc;
    border-top: 1px solid #e2e8f0;
    border-bottom: 1px solid #e2e8f0;
    padding: 1.25rem 0;
    margin-bottom: 2rem;
  }
  
  .article-meta-container {
    max-width: 1280px;
    margin: 0 auto;
    padding: 0 2rem;
    display: flex;
    align-items: center;
    gap: 2rem;
    flex-wrap: wrap;
  }
  
  .meta-item {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.9375rem;
    color: #64748b;
  }
  
  .meta-item svg {
    color: #94a3b8;
    flex-shrink: 0;
  }
  
  .meta-item time,
  .meta-item span {
    color: #475569;
    font-weight: 500;
  }
  
  .meta-category a {
    color: #3b82f6;
    font-weight: 600;
    text-decoration: none;
  }
  
  .meta-category a:hover {
    text-decoration: underline;
    color: #2563eb;
  }
  
  @media (max-width: 768px) {
    .article-meta-section {
      padding: 1rem 0;
    }
    
    .article-meta-container {
      padding: 0 1rem;
      gap: 1rem;
      font-size: 0.875rem;
    }
    
    .meta-item {
      font-size: 0.875rem;
    }
    
    .meta-item svg {
      width: 14px;
      height: 14px;
    }
  }
  
  @media (max-width: 480px) {
    .article-meta-container {
      flex-direction: column;
      align-items: flex-start;
      gap: 0.75rem;
    }
  }
  /* Social share buttons - positioned at bottom */
  .social-share {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 1rem;
    margin: 3rem 0 2rem 0;
    padding: 2rem 0;
    border-top: 1px solid #e2e8f0;
    border-bottom: 1px solid #e2e8f0;
  }
  .share-label {
    font-size: 0.875rem;
    color: #64748b;
    font-weight: 500;
  }
  .share-button {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 1rem;
    border-radius: 4px;
    font-size: 0.875rem;
    font-weight: 500;
    text-decoration: none !important;
    border: 1px solid #e2e8f0;
    background: white;
    color: #475569 !important;
    cursor: pointer;
    font-family: inherit;
    outline: none;
  }
  .share-button:hover {
    text-decoration: none !important;
  }
  .share-linkedin:hover {
    background: #0077b5;
    color: white !important;
    border-color: #0077b5;
    text-decoration: none !important;
  }
  .share-facebook:hover {
    background: #1877f2;
    color: white !important;
    border-color: #1877f2;
    text-decoration: none !important;
  }
  .share-x:hover {
    background: #000000;
    color: white !important;
    border-color: #000000;
    text-decoration: none !important;
  }
  .share-copy:hover {
    background: #2c4157;
    color: white !important;
    border-color: #2c4157;
    text-decoration: none !important;
  }
  .share-button svg {
    width: 18px;
    height: 18px;
  }
  .article-content { 
    font-size: 1.125rem; 
    line-height: 1.85;
    color: #2c4157;
    font-weight: 400;
    letter-spacing: -0.01em;
  }
  .article-content > :global(p), 
  .article-content > :global(ul) > :global(li),
  .article-content > :global(ol) > :global(li) { 
    color: #2c4157 !important;
    font-weight: 400;
  }
  /* Simplified CTA */
  .article-cta-simple {
    margin-top: 32px;
    text-align: center;
    padding: 40px 0;
    border-top: 1px solid #e5e7eb;
  }
  .article-cta-simple .cta-button-simple {
    display: inline-block;
    padding: 12px 32px;
    background: #1e3a5f !important;
    color: white !important;
    border: none;
    border-radius: 2px;
    font-size: 13px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    text-decoration: none !important;
    transition: all 0.2s ease;
    cursor: pointer;
  }
  .article-cta-simple .cta-button-simple:hover {
    background: #2c4157 !important;
    color: white !important;
    transform: translateY(-2px);
    text-decoration: none !important;
  }
  /* Sidebar - Increased specificity to avoid conflicts */
  .article-page .article-sidebar,
  aside.article-sidebar {
    position: sticky !important;
    top: var(--sidebar-top) !important; /* Uses calculated variable */
    align-self: start;
    max-height: calc(100vh - var(--sidebar-top) - 20px);
    overflow-y: auto;
    /* Performance optimizations */
    transform: translateZ(0); /* Force GPU acceleration */
    -webkit-transform: translateZ(0);
    contain: layout style; /* Render optimization */
  }
  .sidebar-widget {
    background-color: #fafbfc;
    border: 1px solid #e2e8f0;
    border-radius: 4px;
    padding: 2rem;
    margin-bottom: 2rem;
  }
  .widget-title {
    font-size: 1.125rem;
    font-weight: 600;
    color: #0f172a;
    margin-bottom: 1.5rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }
  /* Category Navigation */
  .category-nav {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }
  .category-link {
    padding: 0.625rem 0.875rem;
    text-decoration: none;
    color: #64748b;
    font-size: 0.875rem;
    font-weight: 500;
    border-radius: 4px;
  }
  .category-link:hover {
    background-color: #f1f5f9;
    color: #0f172a;
  }
  .category-link.is-active {
    background-color: #e2e8f0;
    color: #0f172a;
    font-weight: 600;
  }
  /* Section épurée pour les suggestions */
  .related-articles {
    padding: 6rem 0;
    background-color: #fafbfc;
    position: relative;
  }
  .related-articles::before {
    content: '';
    position: absolute;
    top: 0;
    left: 50%;
    transform: translateX(-50%);
    width: 100px;
    height: 1px;
    background: linear-gradient(90deg, transparent, #e2e8f0, transparent);
  }
  .section-header {
    text-align: center;
    margin-bottom: 3rem;
  }
  .section-header h3 {
    font-size: 2.25rem;
    font-weight: 200;
    color: #0f172a;
    margin-bottom: 1rem;
    letter-spacing: -0.02em;
  }
  .section-header p {
    font-size: 1rem;
    color: #64748b;
    font-weight: 400;
  }
  .related-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
    gap: 24px;
    max-width: 1200px;
    margin: 0 auto;
  }
  .related-card {
    background: #fafbfc;
    border: 1px solid #e5e7eb;
    border-radius: 2px;
    overflow: hidden;
    transition: all 0.2s ease;
  }
  .related-card:hover {
    background: #ffffff;
    border-color: #9ca3af;
    transform: translateY(-2px);
  }
  .related-link {
    text-decoration: none;
    color: inherit;
    display: block;
  }
  .related-image-wrapper {
    overflow: hidden;
    background-color: #fafbfc;
    height: 120px;
  }
  .related-image-wrapper img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: block;
    transition: transform 0.3s ease;
  }
  .related-card:hover .related-image-wrapper img {
    transform: scale(1.05);
  }
  .related-content {
    padding: 24px;
  }
  .related-date {
    display: block;
    font-size: 12px;
    color: #6b7280;
    margin-bottom: 8px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    font-weight: 500;
  }
  .related-title {
    font-size: 18px;
    font-weight: 700;
    margin-bottom: 12px;
    line-height: 1.4;
    color: #111827;
  }
  .related-card:hover .related-title {
    color: #1e3a5f;
  }
  .related-excerpt {
    color: #64748b;
    font-size: 0.875rem;
    line-height: 1.6;
  }
  /* Styles globaux pour le contenu Markdown */
  .article-content :global(h2), 
  .article-content :global(h3), 
  .article-content :global(h4) { 
    line-height: 1.3; 
    margin: 3rem 0 1.25rem 0;
    color: #2c4157;
    font-weight: 600;
  }
  .article-content :global(h2) { 
    font-size: 2rem;
    font-weight: 200;
    margin-top: 4rem;
    margin-bottom: 1.75rem;
    letter-spacing: -0.02em;
    position: relative;
    padding-top: 1rem;
    color: #2c4157;
  }
  .article-content :global(h2)::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 40px;
    height: 2px;
    background: #3b82f6;
  }
  .article-content :global(h3) { 
    font-size: 1.375rem;
    font-weight: 600;
    color: #2c4157;
  }
  .article-content :global(p) { 
    margin-bottom: 1.5rem;
    font-size: 1.125rem;
    line-height: 1.8;
    font-weight: 400;
  }
  .article-content :global(a) { 
    color: #3b82f6; 
    text-decoration: none;
    font-weight: 500;
  }
  .article-content :global(a:hover) { 
    text-decoration: underline;
    color: #2563eb;
  }
  .article-content :global(ul), 
  .article-content :global(ol) { 
    margin-bottom: 1.5rem; 
    padding-left: 2rem; 
  }
  .article-content :global(li) { 
    margin-bottom: 0.5rem;
    line-height: 1.8;
    font-size: 1.125rem;
    font-weight: 400;
  }
  .article-content :global(blockquote) { 
    margin: 2.5rem 0; 
    padding: 2rem 2rem 2rem 2.5rem; 
    background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%); 
    border-left: 3px solid #3b82f6; 
    border-radius: 0 8px 8px 0;
    font-style: normal;
    color: #475569;
    font-size: 1.125rem;
    line-height: 1.8;
    letter-spacing: -0.01em;
    position: relative;
  }
  .article-content :global(blockquote)::before {
    content: '"';
    position: absolute;
    top: 1rem;
    left: 1rem;
    font-size: 2.5rem;
    color: #e2e8f0;
    font-family: Georgia, serif;
    line-height: 1;
    font-weight: 300;
  }
  .article-content :global(blockquote p) { margin-bottom: 0; }
  .article-content :global(img) { 
    max-width: 100%; 
    height: auto; 
    margin: 2rem 0;
    border-radius: 4px;
    border: 1px solid #e2e8f0;
  }
  /* Styles pour les tableaux */
  .article-content :global(table) { 
    width: 100%; 
    margin: 2rem 0; 
    border-collapse: collapse; 
    font-size: 0.9375rem;
    overflow: hidden;
  }
  .article-content :global(th), 
  .article-content :global(td) { 
    border: 1px solid #e2e8f0; 
    padding: 0.75rem 1rem; 
    text-align: left; 
    line-height: 1.5; 
  }
  .article-content :global(th) { 
    background-color: #f8fafc; 
    font-weight: 600;
    color: #0f172a;
    font-size: 0.875rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }
  .article-content :global(tr:hover) {
    background-color: #fafbfc;
  }
  /* Responsive */
  @media (max-width: 768px) {
    /* Barre de métadonnées mobile */
    .article-meta-bar {
      padding: 0.875rem 1rem;
      margin: -1.5rem -1.5rem 1.5rem -1.5rem;
      font-size: 0.8125rem;
      gap: 0.375rem;
    }
    .category-badge {
      font-size: 0.7rem;
    }
    .meta-separator {
      margin: 0 0.125rem;
    }
    .reading-time-icon {
      width: 14px;
      height: 14px;
    }
    /* Titre mobile */
    .article-title {
      font-size: 1.5rem;
      margin-bottom: 2rem;
    }
    .article-content {
      font-size: 1rem;
    }
    .article-content :global(p),
    .article-content :global(li) {
      font-size: 1rem;
    }
    .related-grid {
      grid-template-columns: 1fr;
    }
  }
  @media (max-width: 480px) {
    /* Ultra petit écran */
    .article-meta-bar {
      padding: 0.75rem 0.75rem;
      font-size: 0.75rem;
    }
    /* Sur très petit écran, passer en colonne */
    @media (max-width: 380px) {
      .article-meta-bar {
        flex-direction: column;
        align-items: flex-start;
        gap: 0.5rem;
      }
      .meta-separator {
        display: none;
      }
    }
  }
</style>