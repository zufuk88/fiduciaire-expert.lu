---
// src/pages/fr/articles/index.astro
import { getCollection } from 'astro:content';
import LayoutI18n from '../../../layouts/LayoutI18n.astro';
import SearchBar from '../../../components/SearchBar.astro';
import StickyPageTop from '../../../components/StickyPageTop.astro';
import ArticlesGrid from '../../../components/ArticlesGrid.astro';
// Pagination
const POSTS_PER_PAGE = 6;
const currentPage = 1; // Page d'accueil = page 1
// La logique de récupération des articles est inchangée
const allPosts = await getCollection('blog');
const frenchCategories = ['Fiscalité', 'Social', 'Comptabilité', 'Juridique'];
const frenchPosts = allPosts.filter(post => {
  // Accepter tous les articles français (ceux dont le slug commence par 'fr/')
  const isFrench = post.slug.startsWith('fr/');
  return isFrench && post.data.draft !== true;
});
let sortedPosts = frenchPosts.sort((a, b) => {
  // Utiliser modified s'il existe, sinon utiliser date
  const dateA = new Date(a.data.modified || a.data.date).getTime();
  const dateB = new Date(b.data.modified || b.data.date).getTime();
  return dateB - dateA;
});
// Préparer les catégories avec compteur
const categoriesWithCount = frenchCategories.map(cat => {
  const slug = cat.toLowerCase().replace(/\s+/g, '-').replace(/'/g, '-');
  const count = sortedPosts.filter(post => 
    post.data.category?.toLowerCase().replace(/\s+/g, '-').replace(/'/g, '-') === slug
  ).length;
  
  return {
    name: cat,
    slug: slug,
    count: count
  };
});

// Limiter à POSTS_PER_PAGE articles pour la première page
const paginatedPosts = sortedPosts.slice(0, POSTS_PER_PAGE);

// Transformer les posts paginés pour ArticlesGrid
const articles = paginatedPosts.map(post => ({
  title: post.data.title,
  excerpt: post.data.description || '',
  slug: post.slug.replace('fr/', ''),
  date: post.data.date.toISOString(),
  category: post.data.category || 'Non catégorisé',
  categorySlug: post.data.category?.toLowerCase().replace(/\s+/g, '-').replace(/'/g, '-') || 'non-categorise',
  author: post.data.author || 'Fiduciaire Expert',
  readTime: post.data.readingTime || '5',
  image: post.data.image?.src,
  tags: post.data.tags || []
}));

// SOLUTION SCALABLE : Limiter à 50 articles récents pour le filtrage rapide
// Au-delà, on redirige vers la page catégorie dédiée
const MAX_ARTICLES_FOR_INSTANT_FILTER = 50;
const recentArticles = sortedPosts.slice(0, MAX_ARTICLES_FOR_INSTANT_FILTER);

// Transformer seulement les 50 derniers articles pour le filtrage
const allArticles = recentArticles.map(post => ({
  title: post.data.title,
  excerpt: post.data.description || '',
  slug: post.slug.replace('fr/', ''),
  date: post.data.date.toISOString(),
  category: post.data.category || 'Non catégorisé',
  categorySlug: post.data.category?.toLowerCase().replace(/\s+/g, '-').replace(/'/g, '-') || 'non-categorise',
  author: post.data.author || 'Fiduciaire Expert',
  readTime: post.data.readingTime || '5',
  image: post.data.image?.src,
  tags: post.data.tags || []
}));

// Calculer si chaque catégorie a plus d'articles que la limite
const categoryHasMore = {};
frenchCategories.forEach(cat => {
  const slug = cat.toLowerCase().replace(/\s+/g, '-').replace(/'/g, '-');
  const totalInCategory = sortedPosts.filter(post => 
    post.data.category?.toLowerCase().replace(/\s+/g, '-').replace(/'/g, '-') === slug
  ).length;
  categoryHasMore[slug] = totalInCategory > MAX_ARTICLES_FOR_INSTANT_FILTER;
});

const categories = frenchCategories;
const totalPages = Math.max(1, Math.ceil(sortedPosts.length / POSTS_PER_PAGE));
const hasMorePosts = sortedPosts.length > POSTS_PER_PAGE;
// Schema.org pour la page d'articles
const articlesSchema = {
  "@context": "https://schema.org",
  "@graph": [
    {
      "@type": "CollectionPage",
      "@id": "https://fiduciaire-expert.lu/fr/articles",
      "name": "Articles Expert Comptable Luxembourg | Blog Fiduciaire Expert",
      "description": `Découvrez nos ${sortedPosts.length} articles d'experts sur la comptabilité, fiscalité IRC/ICC/IF et TVA, création d'entreprise au Luxembourg.`,
      "url": "https://fiduciaire-expert.lu/fr/articles",
      "isPartOf": {
        "@id": "https://fiduciaire-expert.lu/#website"
      },
      "breadcrumb": {
        "@type": "BreadcrumbList",
        "itemListElement": [
          {
            "@type": "ListItem",
            "position": 1,
            "name": "Accueil",
            "item": "https://fiduciaire-expert.lu/fr"
          },
          {
            "@type": "ListItem",
            "position": 2,
            "name": "Articles",
            "item": "https://fiduciaire-expert.lu/fr/articles"
          }
        ]
      }
    },
    {
      "@type": "Blog",
      "@id": "https://fiduciaire-expert.lu/fr/articles#blog",
      "name": "Blog Fiduciaire Expert Luxembourg",
      "description": "Conseils et actualités en comptabilité, fiscalité, paie et droit des sociétés au Luxembourg",
      "url": "https://fiduciaire-expert.lu/fr/articles",
      "inLanguage": "fr-FR",
      "publisher": {
        "@type": "Organization",
        "name": "Fiduciaire Expert",
        "url": "https://fiduciaire-expert.lu"
      },
      "blogPost": sortedPosts.slice(0, 10).map(post => ({
        "@type": "BlogPosting",
        "headline": post.data.title,
        "description": post.data.description,
        "datePublished": post.data.date.toISOString(),
        "dateModified": (post.data.modified || post.data.date).toISOString(),
        "url": `https://fiduciaire-expert.lu/fr/articles/${post.slug.replace('fr/', '')}`,
        "image": post.data.image ? `https://fiduciaire-expert.lu${post.data.image.src}` : undefined,
        "author": {
          "@type": "Organization",
          "name": "Fiduciaire Expert"
        },
        "articleSection": post.data.category,
        "keywords": post.data.tags?.join(', ')
      }))
    }
  ]
};
---
<LayoutI18n
  title="Articles Expert Comptable Luxembourg | Blog Comptabilité Fiscalité"
  description={`${sortedPosts.length} articles d'expertise comptable : IRC/ICC/IF et TVA Luxembourg, création SARL/SA, paie CCSS. Conseils fiscaux et comptables par experts agréés.`}
  canonical="https://fiduciaire-expert.lu/fr/articles"
  schema={articlesSchema}
>
  {/* Balise link pour next page SEO */}
  {hasMorePosts && (
    <Fragment slot="head">
      <link rel="next" href="/fr/articles/page/2" />
    </Fragment>
  )}
  <StickyPageTop
    breadcrumbItems={[
      { text: "Accueil", href: "/fr" },
      { text: "Blog" }
    ]}
    title="Articles d'expertise comptable et fiscale"
    subtitle="Guides pratiques sur la comptabilité luxembourgeoise, déclarations fiscales IRC/ICC/IF et TVA, gestion paie CCSS et création de sociétés."
    showFilters={true}
    categories={categoriesWithCount}
    lang="fr"
  />
  {sortedPosts.length > 0 ? (
    <>
      <section class="articles-page">
        <div class="container">
          <SearchBar 
            placeholder="Rechercher un article..." 
            lang="fr"
          />
          
          <ArticlesGrid
            title="Nos derniers articles"
            subtitle="Restez informé des actualités fiscales et comptables au Luxembourg"
            articles={articles}
            lang="fr"
          />
        </div>
      </section>
      
      {/* Pagination - cachée lors du filtrage */}
      {hasMorePosts && (
        <div class="pagination-section" id="pagination-section">
          <div class="container">
            <div class="pagination">
              <span class="pagination-info">
                Page {currentPage} sur {totalPages}
              </span>
              <a href="/fr/articles/page/2" rel="next" class="pagination-next">
                Articles suivants
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M9 18l6-6-6-6" />
                </svg>
              </a>
            </div>
          </div>
        </div>
      )}
    </>
  ) : (
    <section class="no-posts-section">
      <div class="container">
        <p>Aucun article n'a été publié pour le moment. Revenez bientôt !</p>
      </div>
    </section>
  )}
  <script define:vars={{ articles, allArticles, categoryHasMore }}>
    // Passer les données des articles à la fenêtre pour la recherche
    window.articlesData = articles;
    // Passer les 50 derniers articles pour le filtrage rapide
    window.allArticlesData = allArticles;
    // Indiquer quelles catégories ont trop d'articles pour le filtrage instantané
    window.categoryHasMore = categoryHasMore;
  </script>
</LayoutI18n>

<style>
  .articles-page {
    padding: var(--section-padding);
    background: var(--bg);
  }
  
  .container {
    max-width: var(--container-max, 1200px);
    margin: 0 auto;
    padding: 0 var(--section-padding-x);
  }
  
  .pagination-section {
    padding: var(--section-padding);
    background: var(--bg);
  }
  
  .pagination {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: var(--gap-md, 24px);
    padding: var(--section-padding-x);
    background: var(--white);
    border-radius: var(--radius-lg, 12px);
    box-shadow: 0 2px 8px var(--card-shadow-hover);
  }
  
  .pagination-info {
    font-family: var(--font-family);
    font-size: var(--text-base);
    color: var(--fg-secondary);
  }
  
  .pagination-next {
    display: flex;
    align-items: center;
    gap: var(--gap-sm, 8px);
    padding: var(--btn-padding-y, 10px) var(--btn-padding-x, 20px);
    background: var(--accent);
    color: var(--white);
    text-decoration: none;
    border-radius: var(--radius, 8px);
    font-family: var(--font-family);
    font-size: var(--text-base);
    font-weight: 500;
    transition: all 0.2s ease;
  }
  
  .pagination-next:hover {
    background: var(--accent-dark);
    transform: translateX(var(--hover-translate, 2px));
  }
  
  .no-posts-section {
    padding: var(--section-padding);
    text-align: center;
    font-family: var(--font-family);
    font-size: var(--text-lg);
    color: var(--gray-muted);
  }
  
  @media (max-width: 768px) {
    .articles-page {
      padding: var(--section-padding-tablet);
    }

    .container {
      padding: 0 var(--section-padding-x-tablet);
    }

    .pagination-section {
      padding: var(--section-padding-tablet);
    }

    .pagination {
      flex-direction: column;
      gap: var(--gap-md, 16px);
      padding: var(--section-padding-x-tablet);
    }
  }

  @media (max-width: 480px) {
    .articles-page {
      padding: var(--section-padding-mobile);
    }

    .container {
      padding: 0 var(--section-padding-x-mobile);
    }

    .pagination-section {
      padding: var(--section-padding-mobile);
    }

    .pagination {
      padding: var(--section-padding-x-mobile);
    }
  }
</style>